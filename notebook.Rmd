---
title: "Advanced Social Networks"
output:
  html_document:
    df_print: paged
---

<style>
  body {text-align: justify}
</style>

### University of Trento, 2021-2022

<p align="center">
  ![](images/unitn_logo.png)
</p>

<br>

### Exercises for the final paper

---

### Group Members

Mattolin Giulio, 224072

Paolazzi Elisa, 224424

Passabì Daniele, 221229

---

## 1. Drawing a network using R

You are provided with a unique Excel file (EXERCISE0XX.xls), which contains the directed network (Bullying sheet) capturing who bullies whom among a group of students in an Italian school class. The network was based on asking every person the question “Who do you bully?”.

You are also given a spreadsheet with attributes for each student (Attributes sheet). This included the attributes:

-	The student’s gender (0=female, 1=male),
- The student’s grade (which goes from 0 to 10, with 10 being the highest grade),
-	The student’s ethnicity, where: 
    
    - 1=born abroad with foreign parents (first generation immigrants),
    -	2=born in Italy with foreign parents (second generation immigrants), 
    -	3=born in Italy with at least one Italian parent (which we label “Italian”)

### 1.1 

Draw the network using the Fruchterman-Reingold layout with names (but without attributes). Add the R script of how you obtained the drawings.

```{r message=FALSE, warning=FALSE}

library(xlsx)
library(dplyr)

# Import .xlsx file
bully_xlsx = read.xlsx("data/EXERCISE006.xlsx", sheetName = "Bullying", header = TRUE)

# Fix the column types (from dbl to int)
bully_xlsx = bully_xlsx %>% 
  mutate_if(is.numeric, as.integer)

# Set the first column as Row Index
bully_xlsx = data.frame(bully_xlsx[,-1], row.names = bully_xlsx[,1])

# Convert the data to a matrix
bully_matrix = as.matrix(bully_xlsx)
bully_matrix

```

```{r message=FALSE}

library(sna)

# Convert the matrix into a "network" object
bully_network = as.network(bully_matrix, directed = TRUE)
bully_network

```


```{r fig.height=14, fig.width=14}

# Plot the network

gplot(bully_network, 
      gmode = "digraph",
      
      # layout
      mode = "fruchtermanreingold",
      jitter = F,
      
      # ties
      edge.col = "grey70",
      
      # nodes
      vertex.col = "#59A5D8",
      vertex.cex = 1,
      
      # arrow
      arrowhead.cex = 0.5,
      
      # labels
      displaylabels = T,
      label.pos = 1,
      label.cex = 1
      )

```


### 1.2

Next draw the network again using the Fruchterman-Reingold layout without names, but now with all 3 attributes (gender, grade and ethnicity) included using in some way a combination of color, shape and size of nodes. Add the R script of how you obtained the drawings. 

```{r}

# Import .xlsx attributes data
attributes_xlsx = read.xlsx("data/EXERCISE006.xlsx", sheetName = "Attributes", header = TRUE)
attributes_xlsx

```

```{r fig.height=14, fig.width=14}

# Prepare color vector for gender
genderVectorColor = c()
for (g in attributes_xlsx$Gender) {
  if (g == 1) {
    genderVectorColor = append(genderVectorColor, "#63A088")
  } else {
    genderVectorColor = append(genderVectorColor, "#A975A9")
  }
}

# Prepare color vector for ethnicity
ethnicityVectorColor = c()
for (e in attributes_xlsx$Ethnicity) {
  if (e == 1) {
    ethnicityVectorColor = append(ethnicityVectorColor, 50)
  } else if (e == 2) {
    ethnicityVectorColor = append(ethnicityVectorColor, 3)
  } else {
    ethnicityVectorColor = append(ethnicityVectorColor, 4)
  }
}

# Plot the network
plot = gplot(bully_network, 
      gmode = "digraph",
      
      # layout
      mode = "fruchtermanreingold",
      jitter = T,
      
      # ties
      edge.col = "grey70",
      
      # nodes
      vertex.col = genderVectorColor,
      vertex.cex = attributes_xlsx$Grade/5,
      vertex.sides = ethnicityVectorColor,
      
      # arrow
      arrowhead.cex = 0.5,
      
      # labels
      displaylabels = F,
      label.pos = 1,
      label.cex = 1
      )

```


### 1.3

Create a legend for the attributes (this does not have to be with R, but needs to clarify how the different attributes were represented in the network).

```{r fig.height=14, fig.width=14}

# Prepare color vector for gender
genderVectorColor = c()
for (g in attributes_xlsx$Gender) {
  if (g == 1) {
    genderVectorColor = append(genderVectorColor, "#63A088")
  } else {
    genderVectorColor = append(genderVectorColor, "#A975A9")
  }
}

# Prepare color vector for ethnicity
ethnicityVectorColor = c()
for (e in attributes_xlsx$Ethnicity) {
  if (e == 1) {
    ethnicityVectorColor = append(ethnicityVectorColor, 50)
  } else if (e == 2) {
    ethnicityVectorColor = append(ethnicityVectorColor, 3)
  } else {
    ethnicityVectorColor = append(ethnicityVectorColor, 4)
  }
}

# Plot the network
gplot(bully_network, 
      gmode = "digraph",
      
      # layout
      mode = "fruchtermanreingold",
      jitter = T,
      
      # ties
      edge.col = "grey70",
      
      # nodes
      vertex.col = genderVectorColor,
      vertex.cex = attributes_xlsx$Grade/5,
      vertex.sides = ethnicityVectorColor,
      
      # arrow
      arrowhead.cex = 0.5,
      
      # labels
      displaylabels = F,
      label.pos = 1,
      label.cex = 1
      )

# Customize the legend
legend(
  "topleft",
  
  legend = c(
    "GENDER",
    "Male", 
    "Female", 
    " ", 
    "ETHNICITY", 
    "1st Generation Immigrant (1)", 
    "2nd Generation Immigrant (2)", 
    "Italian (3)", 
    " ", 
    "GRADE", 
    "1", 
    "5",
    "10"),
  
  col = c(
    "white",
    "#63A088",
    "#A975A9",
    "white",
    "white",
    "gray",
    "gray",
    "gray",
    "white",
    "white",
    "gray",
    "gray",
    "gray"
    ), 
  
  bty = "n", 
  pch = c(19,19,19,19, 19,16,17,18,19, 16,16,16,16),
  pt.cex = c(0,2.1,2.1,0, 0,2.1,1.9,2.1,0, 2.1,1,1.55,2.1), 
  cex = 1, 
  text.col = "grey10", 
  horiz = F, 
  inset = c(0)
  )

```

---

## 2. Centrality

### 2.1

Calculate *indegree* and *outdegree* **centrality** for each node and interpret your results. 

- Provide the indegree and outdegree centrality score for each node.
- Who is the most central when it comes to indegree?
    - Provide details of the meaning of the value (taking into account that the network is “who do you bully?”).
    - Make sure to discuss the reference points for the indegree measure. How does it compare to the theoretical minimum and maximum value?
- Who is the most central when it comes to outdegree?
    - Provide details of the meaning of the value (taking into account that the network is “who do you bully?”).
    - Make sure to discuss the reference points for the outdegree measure. How does it compare to the theoretical minimum and maximum value?
    
    
#### Provide the indegree and outdegree centrality score for each node.

```{r}

id = rownames(bully_xlsx)
indegree = sna::degree(bully_network, gmode = "digraph", cmode = "indegree")
outdegree = sna::degree(bully_network, gmode = "digraph", cmode = "outdegree")
freeman = sna::degree(bully_network, gmode = "digraph", cmode = "freeman")

degree_df = data.frame(id, indegree, outdegree, freeman)
degree_df

```

#### Who is the most central when it comes to indegree?

```{r}

degree_df[degree_df$indegree == max(degree_df$indegree),]

```

##### Provide details of the meaning of the value (taking into account that the network is “who do you bully?”)

Since the network answers the question "who do you bully?" and the indegree value represents incoming ties, we can say that Sara is the most bullied person in the network.

##### Make sure to discuss the reference points for the indegree measure. How does it compare to the theoretical minimum and maximum value?

The minimum possible value for Indegree is 0, i.e. the situation where a node is not bullied by any other node.
The maximum value is instead $n$ - 1 (in this case 25 - 1 = 24), meaning that a node is bullied by all other nodes except itself.

We can normalize the obtained Indegree value to get the proportion of people bullying Sara, from a scale that goes from 0 to 1.

$$
NormalizedIndegree = \frac{Indegree}{n-1} = \frac{9}{25-1} = 0.375
$$

From the *NormalizedIndegree* value we can see that Sara is bullied by more than 1/3 of the people in the network.



#### Who is the most central when it comes to outdegree?

```{r}

degree_df[degree_df$outdegree == max(degree_df$outdegree),]

```

##### Provide details of the meaning of the value (taking into account that the network is “who do you bully?”).

In this case the measure refers to the number of people in the network that Francesco says he bullies.

##### Make sure to discuss the reference points for the outdegree measure. How does it compare to the theoretical minimum and maximum value?

Again, the minimum is 0, in the hypothetical situation where a node does not bully anyone and the maximum is $n$ nodes - 1, in the situation where an actor bullies all other nodes except himself.

We find the normalized value:

$$
NormalizedOutdegree = \frac{Outdegree}{n-1} = \frac{8}{25-1} = 0.333
$$

Francesco bullies 1/3 of the network.

```{r fig.height=14, fig.width=14}

# Prepare color vector for gender
genderVectorColor = c()
for (g in attributes_xlsx$Gender) {
  if (g == 1) {
    genderVectorColor = append(genderVectorColor, "#63A088")
  } else {
    genderVectorColor = append(genderVectorColor, "#A975A9")
  }
}

genderVectorColor[which(degree_df$id == "Sara")] = "#F9A03F"
genderVectorColor[which(degree_df$id == "Francesco")] = "#CA1551"

# Prepare color vector for ethnicity
ethnicityVectorColor = c()
for (e in attributes_xlsx$Ethnicity) {
  if (e == 1) {
    ethnicityVectorColor = append(ethnicityVectorColor, 50)
  } else if (e == 2) {
    ethnicityVectorColor = append(ethnicityVectorColor, 3)
  } else {
    ethnicityVectorColor = append(ethnicityVectorColor, 4)
  }
}

# Plot the network
gplot(bully_network, 
      gmode = "digraph",
      
      # layout
      mode = "fruchtermanreingold",
      jitter = T,
      
      # ties
      edge.col = "grey70",
      
      # nodes
      vertex.col = genderVectorColor,
      vertex.cex = attributes_xlsx$Grade/5,
      vertex.sides = ethnicityVectorColor,
      
      # arrow
      arrowhead.cex = 0.5,
      
      # labels
      displaylabels = F,
      label.pos = 1,
      label.cex = 1
      )

# Customize the legend
legend(
  "topleft",
  
  legend = c(
    "GENDER",
    "Male", 
    "Female", 
    " ", 
    "ETHNICITY", 
    "1st Generation Immigrant (1)", 
    "2nd Generation Immigrant (2)", 
    "Italian (3)", 
    " ", 
    "GRADE", 
    "1", 
    "5",
    "10"),
  
  col = c(
    "white",
    "#63A088",
    "#A975A9",
    "white",
    "white",
    "gray",
    "gray",
    "gray",
    "white",
    "white",
    "gray",
    "gray",
    "gray"
    ), 
  
  bty = "n", 
  pch = c(19,19,19,19, 19,16,17,18,19, 16,16,16,16),
  pt.cex = c(0,2.1,2.1,0, 0,2.1,1.9,2.1,0, 2.1,1,1.55,2.1), 
  cex = 1, 
  text.col = "grey10", 
  horiz = F, 
  inset = c(0)
  )

```

The last graph highlights that Sara has high marks (9), while Francesco has lower marks (5). Francesco is a first generation immigrant, while Sara is a second generation immigrant.

### 2.2

Let’s assume we hypothesize that the grade of students might be impacted by how many others they are being bullied by. Calculate the correlation between the indegree and the grade of the kid.

- What is the correlation value?
- What does it mean substantively?
- Provide the R script of how you obtain the results.


```{r}
merge_df <- cbind(attributes_xlsx, degree_df$indegree, degree_df$outdegree)
names(merge_df)[5] = "Indegree"
names(merge_df)[6] = "Outdegree"
merge_df
```

```{r}
cor.test(merge_df$Grade, merge_df$Indegree)
```

```{r message=FALSE, warning=FALSE}
library(ggplot2)

ggplot(merge_df, aes(x=Indegree, y=Grade)) + 
    geom_point(size=3) +
    geom_smooth(method=lm , color="red", se=FALSE)
```

Looking at the results we can say that there is a high correlation between the grade and the indegree (how much a  person is bullied). We can see that this result is statistically significant given its low p-value. Moreover, we can say that a person with high grades tends to be bullied more, as we saw in Sara's example and in the scatterplot above.


Out of curiosity, we also inspect the correlation between the outdegree and the grades.


```{r}
cor.test(merge_df$Grade, merge_df$Outdegree)
```

```{r message=FALSE, warning=FALSE}
ggplot(merge_df, aes(x=Outdegree, y=Grade)) + 
    geom_point(size=3) +
    geom_smooth(method=lm , color="red", se=FALSE)
```

In this case, we have a low negative correlation (-0.20) and a quite high p-value, thus the result cannot be considered as statically significant.


### 2.3

Finally, perform a significance test using a permutation-based approach for the correlation as discussed in class.

-	What does the significance test do and what do you conclude?
-	Add the R script of how you obtained the results.

```{r}
set.seed(1)

n_permutation = 20000

OUTPUT<-matrix(NA,n_permutation,1)
for (k in c(1:n_permutation))
{
  grade_PERM<-sample(merge_df$Grade)
  OUTPUT[k,1]<-cor(merge_df$Indegree, grade_PERM)
}

hist(OUTPUT, nclass=30, prob=T)
abline(v = mean(OUTPUT) + sd(OUTPUT)*1.96, col = "red", lwd = 3) # 0.4012781
abline(v = mean(OUTPUT) - sd(OUTPUT)*1.96, col = "red", lwd = 3) # -0.4001141

```

```{r}
corRealValue = cor(merge_df$Grade, merge_df$Indegree)

message("% of times that the correlation were >= the found correlation value")
sum(OUTPUT >= +abs(corRealValue))/n_permutation

message("\n% of times that the correlation were < the found correlation value")
sum(OUTPUT <= -abs(corRealValue))/n_permutation

message("\n% of times that the correlation were >= or < the found correlation value")
sum(OUTPUT >= +abs(corRealValue))/n_permutation + sum(OUTPUT <= -abs(corRealValue))/n_permutation
```

In none of the permutations we obtain a value greater or less than the true correlation value between the indegree and the grades. This confirms what we expected since the p-value is very low and it is therefore highly unlikely that there would be such a correlation by chance. Moreover, as we have seen in the scatterplot there do not seem to be any outliers that affect the correlation.


---

## 3. Centralization and reciprocity

### 3.1

Calculate the *indegree* and *outdegree* **centralization** for this network using the approach discussed in class and interpret.

- Make sure to show *how* you came to these answers.
- What do you conclude substantively (taking into account that the network is “who do you bully?”)?
- Make sure to discuss the reference points for the measure. What is the minimum and maximum value?

```{r}

# TODO

```


### 3.2

Calculate the arc-based reciprocity index for this network and interpret.

- Make sure to show *how* you came to this answer.
- What do you conclude substantively (taking into account that the network is “who do you bully?”)?
- Make sure to discuss the reference points for the measure. What is the minimum, expected and maximum value?

```{r}

# TODO

```

---

<br><br><br><br><br><br><br><br><br><br>
